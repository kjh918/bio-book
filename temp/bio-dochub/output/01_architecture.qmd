# Architecture & I/O

## 1. Repository Structure

### Source Directory (`/storage/home/jhkim/scripts/bioscript/pipeline/cbNIPT/v3.0.0`)
íŒŒì´í”„ë¼ì¸ì˜ í•µì‹¬ ì½”ë“œ ë° ìŠ¤í¬ë¦½íŠ¸ê°€ ìœ„ì¹˜í•œ ë©”ì¸ ë””ë ‰í† ë¦¬ì…ë‹ˆë‹¤.
```text
ğŸ“‚ scripts/
```

### Test Directory (`/storage/home/jhkim/Projects/cbNIPT/260122-GCX-cbNIPT_Workflow/Results/`)
ë¶„ì„ í…ŒìŠ¤íŠ¸ í™˜ê²½ ë° ì„ì‹œ íŒŒì¼ì´ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ì…ë‹ˆë‹¤.
```text
ğŸ“‚ cbNIPT_25_04_01/
  ğŸ“‚ bam/
  ğŸ“‚ copykit/
  ğŸ“‚ fastq_raw/
    ğŸ“‚ cbNIPT_25_04_01_R1_fastqc/
      ğŸ“‚ Icons/
      ğŸ“‚ Images/
    ğŸ“‚ cbNIPT_25_04_01_R2_fastqc/
      ğŸ“‚ Icons/
      ğŸ“‚ Images/
  ğŸ“‚ fastq_trimmed/
  ğŸ“‚ logs/
    ğŸ“‚ 00_fastqc/
    ğŸ“‚ 01_fastp/
    ğŸ“‚ 02_bwa_picard_align_merge/
    ğŸ“‚ 03_samtools_bam_sort_index/
    ğŸ“‚ 04_gatk4_singularity_dedup/
    ğŸ“‚ 05_gatk3_singularity_indel_realign/
    ğŸ“‚ 06_gatk4_singularity_bqsr/
    ğŸ“‚ 07_samtools_filter_index_recal_bam_filter/
    ğŸ“‚ 08_gatk4_singularity_qc_artifacts/
    ğŸ“‚ 09_gatk4_singularity_qc_alignment_summary/
    ğŸ“‚ 10_gatk4_singularity_qc_insert_size/
    ğŸ“‚ 11_gatk4_singularity_qc_wgs_metrics/
    ğŸ“‚ 12_mosdepth_singularity_coverage_100kb/
    ğŸ“‚ 13_copykit_cbnipt_copynumber_analysis.py/
  ğŸ“‚ qc/
  ğŸ“‚ tmp/
ğŸ“‚ cbNIPT_25_04_02/
  ğŸ“‚ bam/
  ğŸ“‚ copykit/
  ğŸ“‚ fastq_raw/
    ğŸ“‚ cbNIPT_25_04_02_R1_fastqc/
      ğŸ“‚ Icons/
      ğŸ“‚ Images/
    ğŸ“‚ cbNIPT_25_04_02_R2_fastqc/
      ğŸ“‚ Icons/
      ğŸ“‚ Images/
  ğŸ“‚ fastq_trimmed/
  ğŸ“‚ logs/
    ğŸ“‚ 00_fastqc/
    ğŸ“‚ 01_fastp/
    ğŸ“‚ 02_bwa_picard_align_merge/
    ğŸ“‚ 03_samtools_bam_sort_index/
    ğŸ“‚ 04_gatk4_singularity_dedup/
    ğŸ“‚ 05_gatk3_singularity_indel_realign/
    ğŸ“‚ 06_gatk4_singularity_bqsr/
    ğŸ“‚ 07_samtools_filter_index_recal_bam_filter/
    ğŸ“‚ 08_gatk4_singularity_qc_artifacts/
    ğŸ“‚ 09_gatk4_singularity_qc_alignment_summary/
    ğŸ“‚ 10_gatk4_singularity_qc_insert_size/
    ğŸ“‚ 11_gatk4_singularity_qc_wgs_metrics/
    ğŸ“‚ 11_mosdepth_singularity_coverage_100kb/
    ğŸ“‚ 12_mosdepth_singularity_coverage_100kb/
    ğŸ“‚ 13_copykit_cbnipt_copynumber_analysis.py/
  ğŸ“‚ qc/
  ğŸ“‚ tmp/
ğŸ“‚ logs/
  ğŸ“‚ 20260219_154333/
  ğŸ“‚ 20260220_080620/
  ğŸ“‚ 20260220_081233/
  ğŸ“‚ 20260220_090837/
  ğŸ“‚ 20260220_094618/
  ğŸ“‚ 20260220_094918/
  ğŸ“‚ 20260220_130943/
  ğŸ“‚ 20260220_145917/
  ğŸ“‚ 20260220_150222/
```

## 2. Pipeline Workflow

ì•„ë˜ëŠ” íŒŒì´í”„ë¼ì¸ì˜ ì „ì²´ ì‹¤í–‰ íë¦„ë„ì…ë‹ˆë‹¤.

```{mermaid}
flowchart TD
    %% [1] ìŠ¤íƒ€ì¼: í”„ë¡œì„¸ìŠ¤ëŠ” íšŒìƒ‰ ë°”íƒ•, ê¸°ë³¸ ì—°ê²°ì„  êµµê²Œ
    classDef proc fill:#e6e6e6,stroke:#999,stroke-width:1px,color:#000;
    linkStyle default stroke:#757575,stroke-width:2px;

    %% [2] ê·¸ë£¹ ë° ë…¸ë“œ ìƒì„± (ê°€ë¡œ í­ 160px ê³ ì •)
    subgraph part1["Pre-processing"]
        fastqc["<div style='width: 160px; text-align: center;'><b>Rawdata Quality Control</b><br><span style='font-size:12px'>(fastqc)</span></div>"]
        fastp["<div style='width: 160px; text-align: center;'><b>Trim adapter and remove low quality reads</b><br><span style='font-size:12px'>(fastp)</span></div>"]
    end
    subgraph part2["Alignment & BAM Processing"]
        bwa_align["<div style='width: 160px; text-align: center;'><b>Mapping</b><br><span style='font-size:12px'>(bwa_align)</span></div>"]
        sort_and_index["<div style='width: 160px; text-align: center;'><b>Sort and index</b><br><span style='font-size:12px'>(sort_and_index)</span></div>"]
        gatk_dedup["<div style='width: 160px; text-align: center;'><b>Remove duplicates</b><br><span style='font-size:12px'>(gatk_dedup)</span></div>"]
        gatk_realign["<div style='width: 160px; text-align: center;'><b>Realign</b><br><span style='font-size:12px'>(gatk_realign)</span></div>"]
        gatk_bqsr["<div style='width: 160px; text-align: center;'><b>Base Quality Score Recalibration</b><br><span style='font-size:12px'>(gatk_bqsr)</span></div>"]
        samtools_filtering["<div style='width: 160px; text-align: center;'><b>Remove low qualtiy read</b><br><span style='font-size:12px'>(samtools_filtering)</span></div>"]
    end
    subgraph part3["Analysis"]
        copykit["<div style='width: 160px; text-align: center;'><b>Calculate CNV</b><br><span style='font-size:12px'>(copykit)</span></div>"]
    end
    subgraph part4["QC"]
        gatk_qc_artifacts["<div style='width: 160px; text-align: center;'><b>Artifacts</b><br><span style='font-size:12px'>(gatk_qc_artifacts)</span></div>"]
        picard_qc_insert_size["<div style='width: 160px; text-align: center;'><b>Insert Size</b><br><span style='font-size:12px'>(picard_qc_insert_size)</span></div>"]
        gatk_qc_alignment_summary["<div style='width: 160px; text-align: center;'><b>Alignment Summary</b><br><span style='font-size:12px'>(gatk_qc_alignment_summary)</span></div>"]
        gatk_qc_wgs_metrics["<div style='width: 160px; text-align: center;'><b>WGS Metrics</b><br><span style='font-size:12px'>(gatk_qc_wgs_metrics)</span></div>"]
        mosdepth_coverage["<div style='width: 160px; text-align: center;'><b>Coverage</b><br><span style='font-size:12px'>(mosdepth_coverage)</span></div>"]
    end

    %% [3] í™”ì‚´í‘œ ì—°ê²° (YAML ë°ì´í„°)
    fastqc --> data_fastq[Fastq]
    data_fastq --> fastp
    fastp --> data_trimmed[Trimmed Fastq]
    data_trimmed --> bwa_align
    bwa_align --> data_bam1[Bam]
    data_bam1 --> gatk_dedup
    gatk_dedup --> data_bam2[Bam]
    aligned_bam_qc[Aligned BAM QC] --> data_bam2

    %% [4] ë””ìì¸ ì…íˆê¸°
        class fastqc proc;
        class fastp proc;
    style part1 fill:none,stroke:#b0bec5,stroke-width:2px,stroke-dasharray: 5 5;
        class bwa_align proc;
        class sort_and_index proc;
        class gatk_dedup proc;
        class gatk_realign proc;
        class gatk_bqsr proc;
        class samtools_filtering proc;
    style part2 fill:none,stroke:#b0bec5,stroke-width:2px,stroke-dasharray: 5 5;
        class copykit proc;
    style part3 fill:none,stroke:#b0bec5,stroke-width:2px,stroke-dasharray: 5 5;
        class gatk_qc_artifacts proc;
        class picard_qc_insert_size proc;
        class gatk_qc_alignment_summary proc;
        class gatk_qc_wgs_metrics proc;
        class mosdepth_coverage proc;
    style part4 fill:none,stroke:#b0bec5,stroke-width:2px,stroke-dasharray: 5 5;
```